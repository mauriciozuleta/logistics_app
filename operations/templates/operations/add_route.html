<script>
document.addEventListener('DOMContentLoaded', function() {
  var editRouteBtn = document.getElementById('edit_route_btn');

  function clearTables() {
    // Clear route summary table
    var routeTable = document.getElementById('route-summary-table');
    if (routeTable) {
      var rows = routeTable.getElementsByTagName('tr');
      for (var i = 1; i < rows.length; i++) {
        for (var j = 0; j < rows[i].cells.length; j++) {
          rows[i].cells[j].innerText = '';
        }
      }
    }
    // Clear payload summary table
    var payloadTable = document.getElementById('payload-summary-table');
    if (payloadTable) {
      var rows = payloadTable.getElementsByTagName('tr');
      for (var i = 1; i < rows.length; i++) {
        for (var j = 0; j < rows[i].cells.length; j++) {
          rows[i].cells[j].innerText = '';
        }
      }
    }
  }

  function activateSelections() {
    fromSelect.disabled = false;
    toSelect.disabled = false;
    finishSelect.disabled = false;
    aircraftSelect.disabled = false;
    routeType.disabled = false;
  }

  if (editRouteBtn) {
    editRouteBtn.addEventListener('click', function() {
      clearTables();
      activateSelections();
    });
  }
  var loadBtn = document.getElementById('load_finish_btn');
  var routeType = document.getElementById('route_type');
  var fromSelect = document.getElementById('from_airport');
  var toSelect = document.getElementById('to_airport');
  var finishSelect = document.getElementById('finish_airport');
  var aircraftSelect = document.getElementById('aircraft_type');

  function getIata(select) {
    var opt = select.options[select.selectedIndex];
    if (!opt || !opt.text) return '';
    var match = opt.text.match(/\/\s*(\w{3})$/);
    return match ? match[1] : opt.text.trim();
  }

  function freezeLists() {
    fromSelect.disabled = true;
    toSelect.disabled = true;
    finishSelect.disabled = true;
    aircraftSelect.disabled = true;
    routeType.disabled = true;
  }

  function getLegs() {
    var fromIata = getIata(fromSelect);
    var toIata = getIata(toSelect);
    var finishIata = getIata(finishSelect);
    var type = routeType.value;
    var legs = [];
    if (type === 'one-way') {
      legs.push({from: fromIata, to: toIata});
    } else if (type === 'round-trip') {
      legs.push({from: fromIata, to: toIata});
      legs.push({from: toIata, to: fromIata});
    } else if (type === 'multiple') {
      legs.push({from: fromIata, to: toIata});
      legs.push({from: toIata, to: finishIata});
    }
    return legs;
  }

  async function fetchDistances(legs) {
    const response = await fetch('/api/leg-distances', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({legs: legs})
    });
    const data = await response.json();
    return data.distances.map(d => d.distance);
  }

  async function fetchAircraftData(aircraftId) {
    const response = await fetch('/api/aircraft-cruise-speed', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({aircraft_id: aircraftId})
    });
    if (response.ok) {
      const data = await response.json();
      // Extend API to return all needed fields
      return data;
    }
  }

  function setLegsAndDistances(distances) {
    var fromIata = getIata(fromSelect);
    var toIata = getIata(toSelect);
    var finishIata = getIata(finishSelect);
    var type = routeType.value;
    var routeTable = document.getElementById('route-summary-table');
    if (routeTable) {
      var rows = routeTable.getElementsByTagName('tr');
      if (type === 'one-way') {
        if (rows[1]) { rows[1].cells[0].innerText = fromIata + ' / ' + toIata; rows[1].cells[1].innerText = distances[0] || ''; }
      } else if (type === 'round-trip') {
        if (rows[1]) { rows[1].cells[0].innerText = fromIata + ' / ' + toIata; rows[1].cells[1].innerText = distances[0] || ''; }
        if (rows[2]) { rows[2].cells[0].innerText = toIata + ' / ' + fromIata; rows[2].cells[1].innerText = distances[1] || ''; }
      } else if (type === 'multiple') {
        if (rows[1]) { rows[1].cells[0].innerText = fromIata + ' / ' + toIata; rows[1].cells[1].innerText = distances[0] || ''; }
        if (rows[2]) { rows[2].cells[0].innerText = toIata + ' / ' + finishIata; rows[2].cells[1].innerText = distances[1] || ''; }
      }
    }
    var payloadTable = document.getElementById('payload-summary-table');
    if (payloadTable) {
      var rows = payloadTable.getElementsByTagName('tr');
      if (type === 'one-way') {
        if (rows[1]) rows[1].cells[0].innerText = fromIata + ' / ' + toIata;
      } else if (type === 'round-trip') {
        if (rows[1]) rows[1].cells[0].innerText = fromIata + ' / ' + toIata;
        if (rows[2]) rows[2].cells[0].innerText = toIata + ' / ' + fromIata;
      } else if (type === 'multiple') {
        if (rows[1]) rows[1].cells[0].innerText = fromIata + ' / ' + toIata;
        if (rows[2]) rows[2].cells[0].innerText = toIata + ' / ' + finishIata;
      }
    }
  }

  function setFlightTimesAndFuel(distances, aircraftData) {
    console.log('Aircraft Data:', aircraftData);
    var routeTable = document.getElementById('route-summary-table');
    if (!routeTable || !aircraftData.cruise_speed) return;
    var rows = routeTable.getElementsByTagName('tr');
    for (var i = 1; i < rows.length; i++) {
      var dist = parseFloat(rows[i].cells[1].innerText);
      let flightTime = '';
      let routeFuel = '';
      let reserveFuel = '';
      let bhCost = '';
      let fuelCost = '';
      let totalLegCost = '';
      if (!isNaN(dist) && aircraftData.cruise_speed > 0) {
        flightTime = dist / aircraftData.cruise_speed;
        rows[i].cells[2].innerText = flightTime ? flightTime.toFixed(2) + ' hr' : '';
        if (aircraftData.fuel_burn_lbs && flightTime) {
          routeFuel = aircraftData.fuel_burn_lbs * flightTime;
          var routeFuelGal = routeFuel / 6.7;
          rows[i].cells[3].innerText = routeFuelGal ? formatNumber(routeFuelGal, 0) : '';
        } else {
          rows[i].cells[3].innerText = '';
        }
        if (aircraftData.min_fuel_landed_lbs !== undefined && aircraftData.min_fuel_alternate_lbs !== undefined) {
          reserveFuel = (parseFloat(aircraftData.min_fuel_landed_lbs) || 0) + (parseFloat(aircraftData.min_fuel_alternate_lbs) || 0);
          var reserveFuelGal = reserveFuel / 6.7;
          rows[i].cells[4].innerText = reserveFuelGal ? formatNumber(reserveFuelGal, 0) : '';
        } else {
          rows[i].cells[4].innerText = '';
        }
        // B/H cost = acmi_cost * flightTime, but if flightTime < 1, use 1
        if (aircraftData.acmi_cost && flightTime) {
          var bhMultiplier = flightTime < 1 ? 1 : flightTime;
          bhCost = aircraftData.acmi_cost * bhMultiplier;
          rows[i].cells[5].innerText = bhCost ? formatCurrency(bhCost) : '';
        } else {
          rows[i].cells[5].innerText = '';
        }
        // Fuel cost: convert routeFuel (lbs) to gallons, then multiply by from airport fuel cost, and if flightTime < 1, multiply result by 2
        // Use route fuel in gallons directly for fuel cost calculation
        var jetAGal = routeFuelGal ? routeFuelGal : 0;
        var fromAirportId = fromSelect.value;
        rows[i].cells[6].innerText = '';
        rows[i].cells[7].innerText = '';
        if (jetAGal > 0 && fromAirportId) {
          (function(rowIdx, jetAGalVal, flightTimeVal) {
            fetch('/api/airport-fuel-cost', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({airport_id: fromAirportId})
            })
            .then(resp => resp.json())
            .then(data => {
              var fuelCostVal = (data.fuel_cost_gl && jetAGalVal) ? data.fuel_cost_gl * jetAGalVal : 0;
              if (flightTimeVal < 1) fuelCostVal *= 2;
              rows[rowIdx].cells[6].innerText = fuelCostVal ? formatCurrency(fuelCostVal) : '';
              // Total leg cost = bhCost + fuelCost
              var bhCostVal = aircraftData.acmi_cost && flightTimeVal ? aircraftData.acmi_cost * (flightTimeVal < 1 ? 1 : flightTimeVal) : 0;
              var totalLegCostVal = bhCostVal + fuelCostVal;
              rows[rowIdx].cells[7].innerText = totalLegCostVal ? formatCurrency(totalLegCostVal) : '';
            });
          })(i, jetAGal, flightTime);
        }
      } else {
        rows[i].cells[2].innerText = '';
        rows[i].cells[3].innerText = '';
        rows[i].cells[4].innerText = '';
        rows[i].cells[5].innerText = '';
        rows[i].cells[6].innerText = '';
        rows[i].cells[7].innerText = '';
      }
    }
  }

  if (loadBtn) {
    loadBtn.addEventListener('click', async function() {
      freezeLists();
      const legs = getLegs();
      const distances = await fetchDistances(legs);
      setLegsAndDistances(distances);
      const aircraftId = aircraftSelect.value;
      const aircraftData = await fetchAircraftData(aircraftId);
      setFlightTimesAndFuel(distances, aircraftData);
    });
  }

  // Format number with comma for thousands and dot for decimals
  function formatNumber(value, decimals = 0) {
    return value ? Number(value).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }) : '';
  }
  // Format number as currency with comma for thousands and dot for decimals
  function formatCurrency(value) {
    return value ? `$${Number(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '';
  }

});
</script>
{% extends 'base.html' %}

{% block content %}
<div class="content-section">
<style>
  .route-form-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    justify-content: center;
    width: 80%;
    margin: 0 auto;
  }
  .route-form-row .form-group {
    flex: 1 1 20%;
    min-width: 0;
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  #load_finish_btn {
    width: 100%;
    height: 38px;
  }
  #route-table-wrapper table {
    width: 100% !important;
    background-color: #181c22 !important;
    color: #FF5C00 !important;
    border-radius: 8px;
    border-collapse: separate;
    border-spacing: 0;
  }
  #route-table-wrapper th, #route-table-wrapper td {
  background-color: #181c22 !important;
  color: #fff !important;
  border: 0.5px solid #2196f3 !important;
  min-width: 150px;
  text-align: center;
  padding: 12px 8px;
  }
  #route-table-wrapper thead {
  background: #23272e !important;
}

#route-table-wrapper thead th {
  color: #FF5C00 !important;
}
  }
</style>
  <h2>Route Information</h2>
  <form method="post">
      <form method="post">
        <div class="route-form-row">
          <div class="form-group">
            <label for="aircraft_type">Aircraft Type</label>
            <select id="aircraft_type" name="aircraft_type" required style="width: 100%;">
              <option value="">Select...</option>
              {% for ac_id, ac_short in aircraft_choices %}
                <option value="{{ ac_id }}">{{ ac_short }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="route_type">Route Type</label>
            <select id="route_type" name="route_type" required style="width: 100%;">
              <option value="round-trip">Round-Trip</option>
              <option value="one-way">One-Way</option>
              <option value="multiple">Multiple</option>
            </select>
          </div>
          <div class="form-group">
            <label for="from_airport"><strong>From</strong></label>
            <select id="from_airport" name="from_airport" required style="width: 100%;">
              <option value="">Select...</option>
              {% for ap_id, ap_label in airport_choices %}
                <option value="{{ ap_id }}">{{ ap_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="to_airport"><strong>To</strong></label>
            <select id="to_airport" name="to_airport" required style="width: 100%;">
              <option value="">Select...</option>
              {% for ap_id, ap_label in airport_choices %}
                <option value="{{ ap_id }}">{{ ap_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="finish_airport" id="finish_airport_label"><strong>Finish in</strong></label>
            <select id="finish_airport" name="finish_airport" style="width: 100%;" disabled title="The 'Finish' field is only available for Route Type: Multiple.">
              <option value="">Select...</option>
              {% for ap_id, ap_label in airport_choices %}
                <option value="{{ ap_id }}">{{ ap_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label style="visibility:hidden; display:block; height:22px;">&nbsp;</label>
            <a href="/coredata/add-airport" class="btn btn-success" style="width: 100%; height: 38px; font-weight: normal; font-family: inherit; background-color: #181c22; color: #176c3a; border: 0.5px solid #176c3a; display: flex; align-items: center; justify-content: center; text-align: center;">Add airport</a>
          </div>
          <div class="form-group">
            <label style="visibility:hidden; display:block; height:22px;">&nbsp;</label>
            <button type="button" id="load_finish_btn" class="btn btn-primary" style="width: 100%; height: 38px; font-weight: normal; font-family: inherit; background-color: #181c22; color: #2196f3; border: 0.5px solid #2196f3;">Load</button>
          </div>
          <div class="form-group">
            <label style="visibility:hidden; display:block; height:22px;">&nbsp;</label>
            <button type="button" id="edit_route_btn" class="btn btn-primary" style="width: 100%; height: 38px; font-weight: normal; font-family: inherit; background-color: #181c22; color: #b34700; border: 0.5px solid #b34700; display: flex; align-items: center; justify-content: center; text-align: center;">Edit Route</button>
          </div>
          <!-- Save Route button moved below the table -->
        </div>
      </form>
  <div id="finish-warning" style="display:none; color: #b94a48; margin-top: 0.5rem; font-weight: bold;">The "Finish" field is only available for Route Type: Multiple.</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var routeType = document.getElementById('route_type');
  var finishSelect = document.getElementById('finish_airport');
  function toggleFinish() {
    if (routeType.value === 'multiple') {
      finishSelect.disabled = false;
      finishSelect.removeAttribute('title');
    } else {
      finishSelect.disabled = true;
      finishSelect.setAttribute('title', "The 'Finish' field is only available for Route Type: Multiple.");
    }
  }
  routeType.addEventListener('change', toggleFinish);
  toggleFinish();
});
</script>
  <div id="load-table-container" style="width:100%; display:flex; justify-content:center; margin-top:2rem; flex-direction:column; align-items:center;">
    <div style="width:100%; max-width:1400px; margin-bottom: 0.5rem; text-align: center;">
      <label style="font-size: 1.3rem; color: #FF5C00; font-weight: bold; letter-spacing: 1px;">Route Summary</label>
    </div>
    <!-- Save Route button removed as requested -->
    <div id="route-table-wrapper" style="width:100%; max-width:1400px; display: flex; justify-content: center;">
      <table id="route-summary-table" class="table table-bordered" style="width:100%; margin: 0 auto; background-color:#181c22; color:#FF5C00; border-radius:8px; border-collapse: separate; border-spacing: 0; font-weight: normal;">
        <thead style="background:#23272e; font-weight: normal;">
          <tr style="font-weight: normal;">
            <th style="min-width:220px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Leg</th>
            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Distance</th>
            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Flight Time</th>
            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Route Fuel (Gls.)</th>
            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Reserve Fuel (Gls.)</th>

            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">B/H Cost (USD)</th>
            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Fuel Cost (USD)</th>
            <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3; font-weight: normal;">Total Leg Cost (USD)</th>
          </tr>
        </thead>
        <tbody style="font-weight: normal;">
          <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          </tr>
          <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          </tr>
          <!-- Totals row removed as requested -->
        </tbody>
      </table>
    </div>
    <div style="width:100%; max-width:1400px; margin-top:2rem; text-align:center;">
      <label style="font-size: 1.3rem; color: #FF5C00; font-weight: bold; letter-spacing: 1px; margin-bottom: 0.5rem;">Payload Summary</label>
      <div id="payload-table-wrapper" style="width:100%; max-width:1400px; display: flex; justify-content: center;">
        <table id="payload-summary-table" class="table table-bordered" style="width:100%; margin: 0 auto; background-color:#181c22 !important; color:#FF5C00 !important; border-radius:8px; border-collapse: separate; border-spacing: 0; font-weight: normal;">
          <thead style="background:#23272e !important; font-weight: normal;">
            <tr style="font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important;">
              <th style="min-width:220px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">Leg</th>
              <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">Aircraft E/W (Lbs.)</th>
              <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">Fuel Weight (Lbs.)</th>
              <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">Max Payload (Lbs.)</th>
              <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">Avail Extra Fuel (Lbs.)</th>
              <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">No-Tank T/O/W</th>
              <th style="min-width:110px; text-align:center; border: 0.5px solid #2196f3 !important; font-weight: normal; background-color:#23272e !important; color:#FF5C00 !important; height:38px;">Tank T/O/W</th>
            </tr>
          </thead>
          <tbody style="font-weight: normal;">
            <tr style="background-color:#181c22 !important; color:#FF5C00 !important;">
              <td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td>
            </tr>
            <tr style="background-color:#181c22 !important; color:#FF5C00 !important;">
              <td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td><td style="background-color:#181c22 !important; color:#fff !important; border:0.5px solid #2196f3 !important;"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="width:100%; max-width:1400px; display: flex; justify-content: center; margin-top: 1.5rem;">
        <button type="submit" id="save_route_btn" class="btn btn-primary" style="width: 100%; height: 38px; font-weight: normal; font-family: inherit; background-color: #181c22; color: #FFD600; border: 0.5px solid #FFD600; display: flex; align-items: center; justify-content: center; text-align: center;">Save Route</button>
      </div>
    </div>
    </div>
  </div>
</div>
{% endblock %}
